// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "https://qzwxisdfwswsrbzvpzlo.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6d3hpc2Rmd3N3c3JienZwemxvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1OTg2NjYsImV4cCI6MjA1NDE3NDY2Nn0.nVV1d-_BfhfVNOSiusg8zSuvPwS4dSB-cJAMGVjujr4";

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

// Check if we're on the production domain
const isProductionDomain = typeof window !== 'undefined' && window.location.hostname.endsWith('.buntinggpt.com');

// Log storage mode for debugging
if (typeof window !== 'undefined') {
  console.log('Supabase auth storage mode:', isProductionDomain ? 'cookie (production)' : 'localStorage (dev)');
}

// Custom cookie storage for cross-subdomain authentication (production only)
const cookieStorage = {
  getItem: (key: string): string | null => {
    try {
      const encodedKey = encodeURIComponent(key) + "=";
      const cookieArray = document.cookie.split(';');
      
      for (let cookie of cookieArray) {
        cookie = cookie.trim();
        if (cookie.indexOf(encodedKey) === 0) {
          const value = cookie.substring(encodedKey.length);
          // Decode the value that was URL-encoded when stored
          const decodedValue = decodeURIComponent(value);
          console.log(`Cookie read [${key}]:`, decodedValue ? 'found (' + decodedValue.length + ' chars)' : 'empty');
          return decodedValue || null;
        }
      }
      console.log(`Cookie read [${key}]: not found`);
      return null;
    } catch (e) {
      console.error('Cookie read error:', e);
      return null;
    }
  },
  
  setItem: (key: string, value: string): void => {
    try {
      const maxAge = 60 * 60 * 24 * 7; // 7 days
      // URL-encode both key and value to handle special characters in JWT
      const encodedKey = encodeURIComponent(key);
      const encodedValue = encodeURIComponent(value);
      document.cookie = `${encodedKey}=${encodedValue}; path=/; domain=.buntinggpt.com; max-age=${maxAge}; SameSite=Lax; Secure`;
      console.log(`Cookie set [${key}]:`, value.length, 'chars');
    } catch (e) {
      console.error('Cookie write error:', e);
    }
  },
  
  removeItem: (key: string): void => {
    try {
      const encodedKey = encodeURIComponent(key);
      document.cookie = `${encodedKey}=; path=/; domain=.buntinggpt.com; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax; Secure`;
      console.log(`Cookie removed [${key}]`);
    } catch (e) {
      console.error('Cookie remove error:', e);
    }
  }
};

// Use localStorage for non-production environments
const devStorage = typeof window !== 'undefined' ? window.localStorage : undefined;

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    storage: isProductionDomain ? cookieStorage : devStorage,
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
    flowType: 'pkce',
  }
});