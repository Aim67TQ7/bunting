// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';
import { cookieStorage, ensureCleanAuthState, purgeAllAuthCookies } from '@/lib/supabase-storage';

const SUPABASE_URL = "https://qzwxisdfwswsrbzvpzlo.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6d3hpc2Rmd3N3c3JienZwemxvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1OTg2NjYsImV4cCI6MjA1NDE3NDY2Nn0.nVV1d-_BfhfVNOSiusg8zSuvPwS4dSB-cJAMGVjujr4";

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

// =============================================================================
// PRODUCTION HOST DETECTION
// Canonical helper: treats buntinggpt.com, www.buntinggpt.com, and all
// *.buntinggpt.com subdomains as production hosts.
// =============================================================================
export const isProductionHost = (hostname: string): boolean => {
  return hostname === 'buntinggpt.com' || 
         hostname === 'www.buntinggpt.com' || 
         hostname.endsWith('.buntinggpt.com');
};

// Check if we're on the production domain
const isProductionDomain = typeof window !== 'undefined' && isProductionHost(window.location.hostname);

// Log storage mode for debugging
if (typeof window !== 'undefined') {
  console.log('[Supabase] Auth storage mode:', isProductionDomain ? 'cookie (production)' : 'localStorage (dev)');
}

// Ensure clean auth state before creating client (purges stale/invalid cookies)
if (typeof window !== 'undefined' && isProductionDomain) {
  const hasValidSession = ensureCleanAuthState();
  if (!hasValidSession) {
    console.log('[Supabase] No valid session found, starting fresh');
  }
}

// Use localStorage for non-production environments (localhost, preview URLs)
const devStorage = typeof window !== 'undefined' ? window.localStorage : undefined;

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    storage: isProductionDomain ? cookieStorage : devStorage,
    storageKey: 'bunting-auth-token', // CRITICAL: Must match across ALL *.buntinggpt.com apps
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
    flowType: 'pkce',
  }
});

// Export utilities for logout handlers and debugging
export { purgeAllAuthCookies };
